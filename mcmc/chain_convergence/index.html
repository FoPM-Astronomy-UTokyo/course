
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FoPM Practical Course at Institute of Astronomy">
      
      
      
        <meta name="author" content="Ryou Ohsawa">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>マルコフ連鎖の収束 - FoPM Practical Course &ndash; Institute of Astronomy</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/config_local.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="deep-orange">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="FoPM Practical Course &amp;ndash; Institute of Astronomy" class="md-header__button md-logo" aria-label="FoPM Practical Course &ndash; Institute of Astronomy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FoPM Practical Course &ndash; Institute of Astronomy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              マルコフ連鎖の収束
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FoPM Practical Course &amp;ndash; Institute of Astronomy" class="md-nav__button md-logo" aria-label="FoPM Practical Course &ndash; Institute of Astronomy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    FoPM Practical Course &ndash; Institute of Astronomy
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        トップページ
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        実習テキスト
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="実習テキスト" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          実習テキスト
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      <label class="md-nav__link" for="__nav_2_1">
        MCMC 入門
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="MCMC 入門" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          MCMC 入門
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        はじめに
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../generate_random_variables/" class="md-nav__link">
        乱数を生成する
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../static_monte_carlo/" class="md-nav__link">
        静的なモンテカルロ法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../markov_chain/" class="md-nav__link">
        動的なモンテカルロ法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../scratchbuild_mcmc/" class="md-nav__link">
        MHMCMC チュートリアル
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          マルコフ連鎖の収束
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        マルコフ連鎖の収束
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    トレースを確認する
  </a>
  
    <nav class="md-nav" aria-label="トレースを確認する">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    分布が適切に収束した場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ステップ幅が狭すぎる場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    ステップ幅が広過ぎる場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    平均値の検定
  </a>
  
    <nav class="md-nav" aria-label="平均値の検定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#t-" class="md-nav__link">
    平均値の検定: t-検定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    自己相関関数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#t-_1" class="md-nav__link">
    平均値の検定: t-検定 (もう一度)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    連鎖内-連鎖間分散の計算
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../references/" class="md-nav__link">
        参考文献
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://www.s.u-tokyo.ac.jp/ja/FoPM/" class="md-nav__link">
        FoPM Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/FoPM-Astronomy-UTokyo/course" class="md-nav__link">
        GitHub repository
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    トレースを確認する
  </a>
  
    <nav class="md-nav" aria-label="トレースを確認する">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    分布が適切に収束した場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ステップ幅が狭すぎる場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    ステップ幅が広過ぎる場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    平均値の検定
  </a>
  
    <nav class="md-nav" aria-label="平均値の検定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#t-" class="md-nav__link">
    平均値の検定: t-検定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    自己相関関数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#t-_1" class="md-nav__link">
    平均値の検定: t-検定 (もう一度)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    連鎖内-連鎖間分散の計算
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="_1">マルコフ連鎖の収束</h1>
<p>マルコフ連鎖モンテカルロ法 (MCMC) では, 生成された状態の列 <span class="arithmatex">\(\{x_i\}_{i=0{\ldots}}\)</span> が定常分布に収束するまで状態遷移を繰り返して連鎖を伸ばす必要があります. ここでは分布が収束しているか, また状態遷移が効率よく行われているかを調べるための方法をいくつか紹介します.</p>
<h2 id="_2">トレースを確認する</h2>
<p>サンプリングされたデータの値を時系列に表示したものをトレースといいます. トレースを確認することで MCMC が機能している (効率よく状態遷移している) かを大まかに確認することができます.</p>
<h3 id="_3">分布が適切に収束した場合</h3>
<p>ここでは例として Rosenbrock の関数<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>を使って以下の確率分布に従う乱数を生成します.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<div class="arithmatex">\[
P(x) \propto \mathrm{e}^{-\left(
  (x_{[0]} - a)^2 + b(x_{[1]} - {x_{[0]}}^2)^2
\right)}
\]</div>
<p><span class="arithmatex">\((a,\,b)\)</span> はそれぞれ <span class="arithmatex">\((2.0,\,0.2)\)</span> としました. 以下にサンプリングした結果を散布図として表示するコードのサンプルと結果を示します. ここでは最初の 1000 個を burn-in として捨てて 10⁵ 個のデータをサンプリングしています.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">lv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">lv</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sample</span><span class="p">[::</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sample</span><span class="p">[::</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;random variable: x0&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;random variable: x1&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="サンプリング結果の散布図" src="../img/try_mhmcmc_rosenbrock.png" /></p>
</details>
<p>Rosenbrock の関数は <span class="arithmatex">\((a,\,a^2)\)</span> に最小値を持ちます. 今回は <span class="arithmatex">\(a=2\)</span> なので散布図で <span class="arithmatex">\((2,\,4)\)</span> 付近にサンプリングされたデータが集まっていることがわかります.</p>
<p><code>mhmcmc</code> で提供されている関数 <code>display_trace()</code> を使ってトレースを表示します. 以下のコードで黄色でハイライトされている部分を加えてください. 1 列目が <span class="arithmatex">\(x_{[0]}\)</span> のトレースとヒストグラムを表しています.  2 列目は <span class="arithmatex">\(x_{[0]}\)</span> のトレースとヒストグラムを表しています.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>

<span class="hll"><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">display_trace</span>
</span><span class="hll"><span class="n">display_trace</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span></code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="サンプリング結果のトレース" src="../img/try_mhmcmc_rosenbrock_trace.png" /></p>
</details>
<p>トレースは <span class="arithmatex">\(x_{[0]}\)</span>, <span class="arithmatex">\(x_{[1]}\)</span> どちらも目立った構造はなく帯状に広がっていることが分かります.<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> 分布が収束していればデータ点の分布は時間に依らないと期待されるため, 大局的にはこのように帯のような見た目になっていると安心できます. また, ヒストグラムのピークは <span class="arithmatex">\(x_{[0]} = 2\)</span>, <span class="arithmatex">\(x_{[1]} = 4\)</span> 付近にあることも確認できます. 目的とする分布に収束しているだろうと判断できます.</p>
<h3 id="_4">ステップ幅が狭すぎる場合</h3>
<p>同じ計算を <code>GaussianStep</code> の幅を極端に狭くして動かしてみます. 黄色でハイライトした部分が更新した箇所です. 一度に移動できる距離が短くなったために, 分布が収束するまでに必要な時間が伸びるだろうと期待されます.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="hll"><span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>

<span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">display_trace</span>
<span class="n">display_trace</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="サンプリング結果のトレース" src="../img/try_mhmcmc_rosenbrock_trace_small.png" /></p>
</details>
<p>トレースを確認すると <span class="arithmatex">\(x_{[0]}\)</span>, <span class="arithmatex">\(x_{[1]}\)</span> どちらも帯状にはならず, ランダムウォーク的な挙動が見えています. ヒストグラムも先ほど確認したような形からは大きく外れています. 提案分布の幅が狭すぎるために分布が収束していない, あるいはステップ幅に対して計算時間が足りていないと判断できます.</p>
<h3 id="_5">ステップ幅が広過ぎる場合</h3>
<p>今度は <code>GaussianStep</code> の幅を極端に広くして動かしてみます. 黄色でハイライトした部分が更新した箇所です. 一度に長い距離を移動できるようになりました. 一方で, 低確率の状態への遷移を頻繁に提案されるため, ほとんどの状態遷移が却下され, 結果として確率分布の収束は遅くなります.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="hll"><span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">100.</span><span class="p">)</span>
</span><span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>

<span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">display_trace</span>
<span class="n">display_trace</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="サンプリング結果のトレース" src="../img/try_mhmcmc_rosenbrock_trace_large.png" /></p>
</details>
<p>トレースを確認すると矩形のラインが確認できます. 状態遷移が却下され続けるため, 位置をほとんど移動することができていないことが分かります. このような場合でも非常に長い時間をかければ定常分布に収束します. しかしながら, このようなトレースが得られた場合には, 一般には計算のセッティングを見直すことが必要だと思われます.</p>
<h2 id="_6">平均値の検定</h2>
<h3 id="t-">平均値の検定: t-検定</h3>
<p>データ列の前半と後半の平均値の差を分布が収束したかどうかを判定する基準として使うことができます.t-検定は 2 つのデータセットの平均値が等しいかどうかを判定する手法です. 先ほどのデータに対して t-検定を適用してみます. 黄色でハイライトした部分が主な変更箇所です. 前半部分と後半部分からそれぞれ 20% ずつ採用して比較します.</p>
<p><code>stats.ttext_ind(a,b)</code> は t-検定に基づいて 2 つのデータセットの平均値が等しいとみなせる確率を返す関数です. 下のサンプルでは <code>pv</code> という変数に確率が格納されています.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="hll"><span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
</span><span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:]</span>
<span class="hll"><span class="n">m</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">shape</span>
</span><span class="hll"><span class="n">m20</span><span class="p">,</span><span class="n">m50</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</span><span class="hll"><span class="n">tv</span><span class="p">,</span><span class="n">pv</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span>
</span><span class="hll">  <span class="n">sample</span><span class="p">[:</span><span class="n">m20</span><span class="p">,:],</span> <span class="n">sample</span><span class="p">[</span><span class="n">m50</span><span class="p">:(</span><span class="n">m50</span><span class="o">+</span><span class="n">m20</span><span class="p">),:],</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;probability(x0[former] == x0[latter]): </span><span class="si">{</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;probability(x1[former] == x1[latter]): </span><span class="si">{</span><span class="n">pv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></code></pre></div>
<details class="summary"><summary>計算結果</summary><div class="highlight"><pre><span></span><code>probability(x0[former] == x0[latter]): 0.0141046
probability(x1[former] == x1[latter]): 2.97703e-05
</code></pre></div>
</details>
<p>上記のサンプルでは計算結果はほぼゼロ (平均値が同じだとはみなせない) でした. t-検定の結果は収束したとは言えないというものになりました.<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup></p>
<p>t-検定ではそれぞれのデータセットに含まれるデータは独立に選ばれたものであるという前提があります. しかしながら, マルコフ連鎖によって生成されたデータセットは直前の状態と強く相関しています. そのため, 独立なサンプリングだとみなせるデータ数は実際にサンプリングしたデータ総数よりも必然的に減っています.</p>
<p>上記の例では全データを 2 つに分けてそのまま平均値の差を検定しました. そのため, 独立なデータ数を不当に水増しして t-検定を実施したことになっています.</p>
<h3 id="_7">自己相関関数</h3>
<p>データセットがどの程度の相関を持っているかを評価する方法に自己相関関数があります. 自己相関関数はデータの時刻を <span class="arithmatex">\(k\)</span> だけシフトさせて, 元のデータとの相関をとることで計算します.</p>
<div class="arithmatex">\[
{\operatorname{autocorr}}\left(k; \{x_i\}_{i=0{\ldots}n}\right)
= \sum_i (x_i - \bar{x}) \, (x_{i+k} - \bar{x})
\quad (-n \leq k \leq n).
\]</div>
<p>以下に自己相関を計算するための Python 関数のサンプルを示します.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">autocorrelation</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39; Calculate auto-correlation of x</span>

<span class="sd">  Parameters:</span>
<span class="sd">    x (numpy.ndarray): Data in (M,N)-array, where M is the number of samples</span>
<span class="sd">        and N is the number of dimensions.</span>

<span class="sd">  Returns:</span>
<span class="sd">    numpy.ndarray: Calculated auto-correlation in a (M,N)-array</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">v</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">var</span>  <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">corr</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">corr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span><span class="n">n</span><span class="p">],</span><span class="n">v</span><span class="p">[:,</span><span class="n">n</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">var</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">M</span>
</code></pre></div>
<p>ただし, このサンプルでは <span class="arithmatex">\(k=0\)</span> のときの値 (<span class="arithmatex">\(\{x_i\}_{i=0{\ldots}}\)</span> の分散) で規格化しています. また, この関数も <code>mhmcmc.py</code> に含まれているので <code>import</code> して使うことができます.</p>
<p>正規分布に従う乱数であれば相関がないことが期待されます. ここでは <code>numpy</code> によって提供されている正規分布関数に従う乱数を使って <code>autocorrelation</code> の挙動を確かめてみます.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">autocorrelation</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>


<span class="n">gen</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="mi">2021</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">k</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;displacement: k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;autocorr for N(0,1)&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="標準正規分布の自己相関関数" src="../img/sample_autocorr.png" /></p>
</details>
<p>相関がなければ自己相関関数の値は 0 になります. 標準正規分布に従う乱数は相関を持たないため <span class="arithmatex">\(k=0\)</span> でのみ 0 でない期待値を持ちます.</p>
<p>それでは MCMC によって生成されたデータ列にこの関数を適用してみましょう.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="hll"><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">autocorrelation</span>
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">:,:]</span>

<span class="hll"><span class="n">k</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">autocorrelation</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span class="hll"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
</span><span class="hll"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">])</span>
</span><span class="hll"><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;autocorr for x0&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">corr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">])</span>
</span><span class="hll"><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;autocorr for x1&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;displacement: k&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span class="hll"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<details class="summary"><summary>計算結果</summary><p><img alt="自己相関関数" src="../img/try_mhmcmc_rosenbrock_autocorr.png" /></p>
</details>
<p>出力されたグラフを見ると <span class="arithmatex">\(k=0\)</span> 以外にも有意に 0 でない値を持つことが分かります. このケースでは <span class="arithmatex">\(x_{[0]}\)</span> でも, <span class="arithmatex">\(x_{[1]}\)</span> でも, おおよそ <span class="arithmatex">\(k=200\)</span> 程度でほぼ 0 になります. つまり, データをすべて使うのではなく 200 個程度おきに使うことで, 相関がほぼ 0 の乱数とみなせると期待できます.</p>
<h3 id="t-_1">平均値の検定: t-検定 (もう一度)</h3>
<p>以上のことをふまえて, もう一度 t-検定を実施してみます. サンプリング総数は 10⁵ 個ですが, 200 個おきにデータを採用するので独立なサンプルとみなせる総データ数は 500 個です. これを 2 つに分けて平均値が等しいかどうかを t-検定で検証します.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
<span class="hll"><span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">::</span><span class="mi">200</span><span class="p">]</span>
</span><span class="n">m</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">shape</span>
<span class="n">m20</span><span class="p">,</span><span class="n">m50</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">tv</span><span class="p">,</span><span class="n">pv</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span>
  <span class="n">sample</span><span class="p">[:</span><span class="n">m20</span><span class="p">,:],</span> <span class="n">sample</span><span class="p">[</span><span class="n">m50</span><span class="p">:(</span><span class="n">m50</span><span class="o">+</span><span class="n">m20</span><span class="p">),:],</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;probability(x0[former] == x0[latter]): </span><span class="si">{</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;probability(x1[former] == x1[latter]): </span><span class="si">{</span><span class="n">pv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><div class="highlight"><pre><span></span><code>probability(x0[former] == x0[latter]): 0.190402
probability(x1[former] == x1[latter]): 0.966328
</code></pre></div>
</details>
<p>前回と大きく変わって, 平均値が同じ分布からのサンプリングだとみなせる確率がそれぞれ 19%, 96% という結果になりました. 前半と後半で有意に違うとはみなせない程度の値になっています. 今回の例のように, サンプリングしたデータ間の相関が影響を与える場合には, データを間引いて独立したサンプリングだとみなせるデータだけを使用する必要があります.<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup></p>
<h2 id="-">連鎖内-連鎖間分散の計算</h2>
<p>時間が許せば MCMC を複数回実行して比較をするという方法が確実です. それぞれのマルコフ連鎖内部の分散 (within-chain) に比べて, 複数のマルコフ連鎖間の分散 (between-chain) が大きい場合には分布が収束していないとみなすことができます.</p>
<p>合計 <span class="arithmatex">\(M\)</span> 回の MCMC を実行し, それぞれの chain で <span class="arithmatex">\(N\)</span> 個のデータをサンプリングしたとします. このとき,  within-chain variance <span class="arithmatex">\(\sigma^2_w\)</span> と between-chain variance <span class="arithmatex">\(\sigma^2_b\)</span> は以下のように書けます.</p>
<div class="arithmatex">\[
\left\{~\begin{aligned}
\sigma^2_w &amp;=
\frac{1}{M(n-1)}\sum_{m=1}^M\sum_{i=1}^n (x_{m,i} - \bar{x}_{m})^2 \\
\sigma^2_b &amp;= \frac{n}{M-1}\sum_{m=1}^M (\bar{x}_m - \bar{x})^2.
\end{aligned}\right.
\]</div>
<p>ここで <span class="arithmatex">\(\bar{x}_m\)</span> は各 chain 内での平均値, <span class="arithmatex">\(\bar{x}\)</span> はデータ全てに対する平均値です. ここで全体の分散<sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup><sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>と between-chain variance <span class="arithmatex">\(\sigma^2_b\)</span> の比の平方根として <span class="arithmatex">\(\hat{R}\)</span> を定義します.</p>
<div class="arithmatex">\[
\hat{R} = \sqrt{1 + \frac{\sigma^2_b - \sigma^2_w}{n\sigma^2_w}}.
\]</div>
<p>この量は <span class="arithmatex">\(\sigma^2_b = \sigma^2_w\)</span> のときに <span class="arithmatex">\(\hat{R} \simeq 1\)</span> となります. 慣習として <span class="arithmatex">\(\hat{R} \lesssim 1.1\)</span>&ndash;<span class="arithmatex">\(1.2\)</span> ほどであれば収束したと考えてよいということになっています.</p>
<p><span class="arithmatex">\(\hat{R}\)</span> をつかって収束したと言えるかどうかを判定してみます. 以下に 4 つの MCMC chains を生成して <span class="arithmatex">\(\hat{R}\)</span> を計算するサンプルを示します.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">mhmcmc</span> <span class="kn">import</span> <span class="n">MHMCMCSampler</span><span class="p">,</span> <span class="n">GaussianStep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">rosenbrock</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">nchain</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">step</span> <span class="o">=</span> <span class="n">GaussianStep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchain</span><span class="p">):</span>
  <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">n</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">MHMCMCSampler</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
  <span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
  <span class="n">sample</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">101000</span><span class="p">)</span>
  <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">1000</span><span class="p">::])</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

<span class="n">nsample</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">intra_mean</span>  <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">global_mean</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">within_var</span>  <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">between_var</span> <span class="o">=</span> <span class="n">nsample</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">intra_mean</span><span class="o">-</span><span class="n">global_mean</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Rhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">between_var</span><span class="o">/</span><span class="n">within_var</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nsample</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rhat values: </span><span class="si">{</span><span class="n">Rhat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<details class="summary"><summary>計算結果</summary><div class="highlight"><pre><span></span><code>Rhat values: [1.00044594 1.00048218]
</code></pre></div>
</details>
<p>計算した <span class="arithmatex">\(\hat{R}\)</span> の値はほぼ 1 に近く, 十分に収束したと判定してもよさそうです.
<sup id="fnref:8"><a class="footnote-ref" href="#fn:8">8</a></sup></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>バナナ型のポテンシャルを持つ関数で, 数値最適化アルゴリズムの性能評価やチュートリアルでよく使われます. 個の商のサンプルとしてこの関数を採用した深い理由は特にありません.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><span class="arithmatex">\(x\)</span> の <span class="arithmatex">\(i\)</span> 番目の要素を <span class="arithmatex">\(x_{[i]}\)</span> で表します.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>この時点ではデータを間引いていないので, より細かく表示させるとランダムウォーク的に動いている様子が見えてきます. 大きなスケールで見ているので潰されているだけです.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>サンプリング数が足りず本当に収束していないのでは？と思うかもしれません. 試しに数を 5 倍に増やしてみたところ確率はさらに減りました. サンプル数が増えることによって差がより有意になったと判定されたようです.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>ちなみに期待値 (単純平均) の計算ではデータの相関は影響しません (収束がデータ数のわりには遅くなるだけ).&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>全体の分散の &ldquo;推定値&rdquo; として <span class="arithmatex">\(\sigma^2_{bw} = \left((n-1)\sigma^2_w + \sigma^2_b\right)/n\)</span> という式を使っているようです. Gelman et al. (2013) によると &ldquo;This quantity <em>overestimates</em> the marginal posterior variance assuming the starting distributions in appropriately overdispersed, but is <em>unbiased</em> &hellip;&rdquo;. とのことでした.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>手元で全体の分散を計算をしてみたら <span class="arithmatex">\(\sigma^2_{bw} = \left((n-1)\sigma^2_w + (1-M^{-1})\sigma^2_b\right)/(n-M^{-1})\)</span> になりました. ただし, データの相関については何も考慮していません. <span class="arithmatex">\(\sigma^2_w\)</span> と <span class="arithmatex">\(\sigma^2_b\)</span> の重み付き平均になるという結果は確認できました.&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p>ただしパラメタを変えて計算してみると <span class="arithmatex">\(\hat{R} \simeq 1\)</span> の場合でもトレースを見るとまったく収束していないというケースもありました. 重要な計算では過信せずにトレースや相関も確認しておいたほうがよいと思います.&#160;<a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../scratchbuild_mcmc/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              MHMCMC チュートリアル
            </div>
          </div>
        </a>
      
      
        <a href="../references/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              参考文献
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Ryou Ohsawa 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
        <script src="../../js/config_mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>